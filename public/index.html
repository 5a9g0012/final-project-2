<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的待辦事項</title>
    <style>
* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    font-family: 'Segoe UI', 'Microsoft JhengHei', -apple-system, BlinkMacSystemFont, sans-serif;
}

body {
    background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 50%, #e2e8f0 100%);
    min-height: 100vh;
    color: #2d3748;
    line-height: 1.6;
    position: relative;
}

/* 添加動態背景效果 */
body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: 
        radial-gradient(circle at 20% 80%, rgba(159, 196, 253, 0.2) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(252, 211, 77, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(196, 181, 253, 0.15) 0%, transparent 50%);
    z-index: -1;
    animation: backgroundFloat 20s ease-in-out infinite;
}

@keyframes backgroundFloat {
    0%, 100% { transform: translateY(0px) rotate(0deg); }
    50% { transform: translateY(-20px) rotate(1deg); }
}

.container {
    max-width: 900px;
    margin: 20px auto;
    padding: 0 20px;
}

.auth-container {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: 24px;
    padding: 60px 40px;
    text-align: center;
    box-shadow: 
        0 20px 40px rgba(0, 0, 0, 0.05),
        0 0 0 1px rgba(255, 255, 255, 0.8);
    border: 1px solid rgba(226, 232, 240, 0.3);
    animation: slideUp 0.8s ease-out;
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.auth-container h1 {
    margin-bottom: 30px;
    background: linear-gradient(135deg, #4299e1, #9f7aea);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-size: 2.5rem;
    font-weight: 700;
}

.google-signin-btn {
    display: inline-flex;
    align-items: center;
    padding: 16px 32px;
    background: linear-gradient(135deg, #4299e1, #3182ce);
    color: white;
    border: none;
    border-radius: 50px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    text-decoration: none;
    box-shadow: 0 8px 20px rgba(66, 153, 225, 0.2);
    position: relative;
    overflow: hidden;
}

.google-signin-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    transition: left 0.5s;
}

.google-signin-btn:hover::before {
    left: 100%;
}

.google-signin-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 30px rgba(66, 153, 225, 0.3);
}

.google-signin-btn svg {
    margin-right: 12px;
}

.user-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding: 20px;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(20px);
    border-radius: 16px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.04);
    border: 1px solid rgba(226, 232, 240, 0.5);
    animation: slideDown 0.6s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.user-profile {
    display: flex;
    align-items: center;
}

.user-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    margin-right: 16px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    transition: transform 0.3s ease;
}

.user-avatar:hover {
    transform: scale(1.05);
}

.user-name {
    font-weight: 600;
    color: #2d3748;
    font-size: 1.1rem;
}

.logout-btn {
    padding: 10px 20px;
    background: linear-gradient(135deg, #f56565, #e53e3e);
    color: white;
    border: none;
    border-radius: 25px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(245, 101, 101, 0.2);
}

.logout-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 6px 16px rgba(245, 101, 101, 0.3);
}

.loading {
    text-align: center;
    padding: 80px 20px;
    font-size: 18px;
    color: #4a5568;
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    margin: 40px auto;
    max-width: 400px;
    border: 1px solid rgba(226, 232, 240, 0.5);
}

.main-content {
    animation: fadeIn 0.8s ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

h1 {
    text-align: center;
    margin-bottom: 40px;
    background: linear-gradient(135deg, #4299e1, #9f7aea);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-size: 3rem;
    font-weight: 800;
    text-shadow: 0 4px 8px rgba(0, 0, 0, 0.02);
}

.task-form {
    margin-bottom: 30px;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(20px);
    padding: 30px;
    border-radius: 20px;
    box-shadow: 
        0 16px 40px rgba(0, 0, 0, 0.04),
        0 0 0 1px rgba(255, 255, 255, 0.8);
    border: 1px solid rgba(226, 232, 240, 0.3);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.task-form:hover {
    transform: translateY(-2px);
    box-shadow: 
        0 20px 50px rgba(0, 0, 0, 0.06),
        0 0 0 1px rgba(255, 255, 255, 0.9);
}

.form-row {
    display: flex;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 20px;
}

.form-group {
    flex: 1;
    min-width: 200px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    font-size: 14px;
    color: #4a5568;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.form-control, .priority-select {
    width: 100%;
    padding: 14px 16px;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    font-size: 16px;
    transition: all 0.3s ease;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
}

.form-control:focus, .priority-select:focus {
    outline: none;
    border-color: #4299e1;
    box-shadow: 0 0 0 4px rgba(66, 153, 225, 0.1);
    transform: translateY(-1px);
}

.btn-container {
    display: flex;
    justify-content: flex-end;
    margin-top: 20px;
}

#add-task-btn {
    padding: 14px 32px;
    background: linear-gradient(135deg, #4299e1, #9f7aea);
    color: white;
    border: none;
    border-radius: 25px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 8px 20px rgba(66, 153, 225, 0.2);
    position: relative;
    overflow: hidden;
}

#add-task-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    transition: left 0.5s;
}

#add-task-btn:hover::before {
    left: 100%;
}

#add-task-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 30px rgba(66, 153, 225, 0.3);
}

.task-filters {
    display: flex;
    justify-content: center;
    margin: 30px 0;
    flex-wrap: wrap;
    gap: 12px;
}

.filter-btn {
    padding: 12px 24px;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    border: 2px solid rgba(66, 153, 225, 0.2);
    border-radius: 25px;
    color: #4299e1;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.02);
}

.filter-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.04);
}

.filter-btn.active {
    background: linear-gradient(135deg, #4299e1, #9f7aea);
    color: white;
    border-color: transparent;
    box-shadow: 0 8px 20px rgba(66, 153, 225, 0.2);
}

.tag-list {
    display: flex;
    justify-content: center;
    margin: 20px 0 30px;
    flex-wrap: wrap;
    gap: 8px;
}

.tag-btn {
    padding: 8px 16px;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(226, 232, 240, 0.5);
    border-radius: 20px;
    color: #4a5568;
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.02);
}

.tag-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
}

.tag-btn.active {
    background: linear-gradient(135deg, #4299e1, #9f7aea);
    color: white;
    border-color: transparent;
    box-shadow: 0 4px 12px rgba(66, 153, 225, 0.2);
}

.task-list {
    list-style-type: none;
    space-y: 12px;
}

.task-item {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    padding: 20px;
    margin-bottom: 12px;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(20px);
    border-radius: 16px;
    border-left: 5px solid #e2e8f0;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.02);
    border: 1px solid rgba(226, 232, 240, 0.3);
    animation: slideInLeft 0.5s ease-out;
}

@keyframes slideInLeft {
    from {
        opacity: 0;
        transform: translateX(-20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.task-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.04);
}

.task-item.priority-high {
    border-left-color: #f56565;
    box-shadow: 0 4px 20px rgba(245, 101, 101, 0.1);
}

.task-item.priority-medium {
    border-left-color: #ed8936;
    box-shadow: 0 4px 20px rgba(237, 137, 54, 0.1);
}

.task-item.priority-low {
    border-left-color: #48bb78;
    box-shadow: 0 4px 20px rgba(72, 187, 120, 0.1);
}

.task-checkbox {
    margin-right: 16px;
    width: 20px;
    height: 20px;
    cursor: pointer;
    accent-color: #4299e1;
    transform: scale(1.2);
}

.task-content {
    flex: 1;
    min-width: 200px;
}

.task-text {
    font-size: 16px;
    font-weight: 500;
    margin-bottom: 8px;
    display: block;
    color: #2d3748;
    line-height: 1.5;
}

.completed .task-text {
    text-decoration: line-through;
    color: #a0aec0;
    opacity: 0.7;
}

.task-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    font-size: 13px;
    color: #718096;
    align-items: center;
}

.due-date {
    display: flex;
    align-items: center;
    padding: 4px 10px;
    background: rgba(66, 153, 225, 0.1);
    border-radius: 12px;
    font-weight: 500;
}

.due-date-icon {
    margin-right: 6px;
    font-size: 14px;
}

.priority-badge {
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.priority-high {
    color: #f56565;
    background: rgba(245, 101, 101, 0.1);
}

.priority-medium {
    color: #ed8936;
    background: rgba(237, 137, 54, 0.1);
}

.priority-low {
    color: #48bb78;
    background: rgba(72, 187, 120, 0.1);
}

.tag {
    display: inline-block;
    margin: 2px 4px;
    padding: 4px 10px;
    border-radius: 12px;
    background: linear-gradient(135deg, #4299e1, #9f7aea);
    color: white;
    font-size: 11px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    box-shadow: 0 2px 6px rgba(66, 153, 225, 0.15);
}

.due-soon {
    color: #ed8936;
    font-weight: 600;
    background: rgba(237, 137, 54, 0.1);
}

.overdue {
    color: #e53e3e;
    font-weight: 600;
    background: rgba(229, 62, 62, 0.1);
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
}

.task-actions {
    display: flex;
    gap: 8px;
    margin-left: auto;
}

.action-btn {
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(226, 232, 240, 0.5);
    border-radius: 8px;
    padding: 8px 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    color: #718096;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    font-weight: 500;
}

.action-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
}

.delete-btn {
    color: #f56565;
    border-color: rgba(245, 101, 101, 0.2);
}

.delete-btn:hover {
    background: rgba(245, 101, 101, 0.05);
    border-color: #f56565;
}

.no-tasks {
    text-align: center;
    color: #718096;
    margin: 60px 0;
    font-style: italic;
    font-size: 18px;
    padding: 40px;
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(10px);
    border-radius: 16px;
    border: 1px solid rgba(226, 232, 240, 0.3);
}

.task-stats {
    text-align: center;
    margin-top: 30px;
    padding: 20px;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(20px);
    border-radius: 16px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.04);
    border: 1px solid rgba(226, 232, 240, 0.3);
    color: #4a5568;
    font-size: 14px;
    font-weight: 500;
}

.sort-options {
    display: flex;
    justify-content: flex-end;
    margin-bottom: 20px;
    align-items: center;
    padding: 12px 20px;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.02);
    border: 1px solid rgba(226, 232, 240, 0.3);
}

.sort-options label {
    margin-right: 12px;
    font-size: 14px;
    font-weight: 500;
    color: #4a5568;
}

.sort-select {
    padding: 8px 12px;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    font-size: 14px;
    transition: all 0.3s ease;
}

.sort-select:focus {
    outline: none;
    border-color: #4299e1;
    box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
}

/* 響應式設計 */
@media (max-width: 768px) {
    .container {
        margin: 10px auto;
        padding: 0 15px;
    }
    
    h1 {
        font-size: 2.2rem;
        margin-bottom: 30px;
    }
    
    .task-form {
        padding: 20px;
    }
    
    .form-group {
        min-width: 100%;
    }
    
    .form-row {
        gap: 15px;
    }
    
    .task-filters {
        gap: 8px;
    }
    
    .filter-btn {
        padding: 10px 16px;
        font-size: 14px;
    }
    
    .task-actions {
        margin-top: 12px;
        margin-left: 0;
        justify-content: flex-end;
        width: 100%;
    }
    
    .task-item {
        padding: 16px;
    }
    
    .user-info {
        flex-direction: column;
        gap: 15px;
        text-align: center;
    }
    
    .sort-options {
        flex-direction: column;
        gap: 10px;
        text-align: center;
    }
}

@media (max-width: 480px) {
    .auth-container {
        padding: 40px 20px;
        margin: 20px;
    }
    
    .task-form {
        padding: 15px;
    }
    
    .task-item {
        padding: 12px;
    }
    
    .task-meta {
        gap: 8px;
    }
}
    </style>
</head>
<body>
    <div class="container">
        <!-- 載入中畫面 -->
        <div id="loading" class="loading">
            載入中...
        </div>

        <!-- 登入畫面 -->
        <div id="auth-container" class="auth-container" style="display: none;">
            <h1>我的待辦事項</h1>
            <p style="margin-bottom: 30px; color: #666;">請登入以管理您的個人待辦清單</p>
            <button id="google-signin-btn" class="google-signin-btn">
                <svg width="18" height="18" viewBox="0 0 18 18">
                    <path fill="#4285F4" d="m18 9.205c0-.639-.057-1.252-.164-1.841H9.212v3.481h4.927c-.212 1.121-.864 2.07-1.84 2.705v2.256h2.981C16.627 14.528 18 12.045 18 9.205z"/>
                    <path fill="#34A853" d="m9.212 18c2.489 0 4.575-.82 6.101-2.232l-2.981-2.256c-.826.551-1.88.878-3.12.878-2.4 0-4.432-1.618-5.156-3.796H1.037v2.332A8.997 8.997 0 0 0 9.212 18z"/>
                    <path fill="#FBBC05" d="M4.056 10.594c-.19-.551-.297-1.137-.297-1.741s.107-1.19.297-1.741V4.78H1.037C.377 6.097 0 7.508 0 9.212s.377 3.115 1.037 4.432l3.019-2.05z"/>
                    <path fill="#EA4335" d="M9.212 3.573c1.353 0 2.568.464 3.521 1.376l2.636-2.636C13.784.894 11.699 0 9.212 0A8.997 8.997 0 0 0 1.037 4.78l3.019 2.332c.724-2.178 2.756-3.539 5.156-3.539z"/>
                </svg>
                使用 Google 登入
            </button>
        </div>

        <!-- 主要內容 -->
        <div id="main-content" class="main-content">
            <!-- 用戶信息 -->
            <div class="user-info">
                <div class="user-profile">
                    <img id="user-avatar" class="user-avatar" src="" alt="用戶頭像">
                    <span id="user-name" class="user-name"></span>
                </div>
                <button id="logout-btn" class="logout-btn">登出</button>
            </div>

            <h1>我的待辦事項</h1>
            
            <div class="task-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="task-input">任務</label>
                        <input type="text" id="task-input" class="form-control" placeholder="添加新任務...">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="due-date-input">到期日</label>
                        <input type="date" id="due-date-input" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="priority-input">優先級</label>
                        <select id="priority-input" class="priority-select">
                            <option value="none">無優先級</option>
                            <option value="low">低</option>
                            <option value="medium">中</option>
                            <option value="high">高</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="tags-input">標籤 (用逗號分隔)</label>
                        <input type="text" id="tags-input" class="form-control" placeholder="工作, 學習, 家庭...">
                    </div>
                </div>
                <div class="btn-container">
                    <button id="add-task-btn">添加任務</button>
                </div>
            </div>
            
            <div class="task-filters">
                <button class="filter-btn active" data-filter="all">全部</button>
                <button class="filter-btn" data-filter="active">進行中</button>
                <button class="filter-btn" data-filter="completed">已完成</button>
                <button class="filter-btn" data-filter="today">今天</button>
                <button class="filter-btn" data-filter="upcoming">即將到期</button>
                <button class="filter-btn" data-filter="overdue">已過期</button>
            </div>
            
            <div class="tag-list" id="tag-list">
                <!-- 標籤將在此動態生成 -->
            </div>
            
            <div class="sort-options">
                <label for="sort-select">排序方式:</label>
                <select id="sort-select" class="sort-select">
                    <option value="default">預設</option>
                    <option value="priority">優先級</option>
                    <option value="dueDate">到期日</option>
                    <option value="createdDate">創建日期</option>
                </select>
            </div>
            
            <ul class="task-list" id="task-list">
                <!-- 任務項目將在此動態生成 -->
            </ul>
            
            <div class="task-stats" id="task-stats">
                <!-- 任務統計將在此顯示 -->
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // Firebase 配置 - 請替換為您的 Firebase 配置
        const firebaseConfig = {
  apiKey: "AIzaSyDS440s0c7dT0PMu5xB6EiJ7GCDZDo3nkI",
  authDomain: "final-project-2-9121b.firebaseapp.com",
  projectId: "final-project-2-9121b",
  storageBucket: "final-project-2-9121b.firebasestorage.app",
  messagingSenderId: "64215769554",
  appId: "1:64215769554:web:3f95a7aec5c90c12fd280b",
  measurementId: "G-FNZCPGQPEH"
};

        // 初始化 Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Google 登入設置
        const provider = new firebase.auth.GoogleAuthProvider();

        // DOM 元素
        const loadingEl = document.getElementById('loading');
        const authContainer = document.getElementById('auth-container');
        const mainContent = document.getElementById('main-content');
        const googleSigninBtn = document.getElementById('google-signin-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userAvatar = document.getElementById('user-avatar');
        const userName = document.getElementById('user-name');

        // 任務相關 DOM 元素
        const taskInput = document.getElementById('task-input');
        const dueDateInput = document.getElementById('due-date-input');
        const priorityInput = document.getElementById('priority-input');
        const tagsInput = document.getElementById('tags-input');
        const addTaskBtn = document.getElementById('add-task-btn');
        const taskList = document.getElementById('task-list');
        const taskStats = document.getElementById('task-stats');
        const filterBtns = document.querySelectorAll('.filter-btn');
        const sortSelect = document.getElementById('sort-select');
        const tagList = document.getElementById('tag-list');

        // 全局變量
        let currentUser = null;
        let tasks = [];
        let currentFilter = 'all';
        let currentSort = 'default';
        let currentTag = null;

        // 監聽認證狀態變化
        auth.onAuthStateChanged((user) => {
            loadingEl.style.display = 'none';
            
            if (user) {
                currentUser = user;
                showMainContent();
            } else {
                currentUser = null;
                showAuthContainer();
            }
        });

        // 顯示登入界面
        function showAuthContainer() {
            authContainer.style.display = 'block';
            mainContent.style.display = 'none';
        }

        // 顯示主要內容
        function showMainContent() {
            authContainer.style.display = 'none';
            mainContent.style.display = 'block';
            
            // 更新用戶信息
            userName.textContent = currentUser.displayName;
            userAvatar.src = currentUser.photoURL;
            
            // 載入用戶的任務
            loadUserTasks();
            
            // 初始化
            setupEventListeners();
            updateDateInput();
        }

        // Google 登入
        googleSigninBtn.addEventListener('click', () => {
            auth.signInWithPopup(provider)
                .then((result) => {
                    console.log('登入成功:', result.user);
                })
                .catch((error) => {
                    console.error('登入失敗:', error);
                    alert('登入失敗，請重試。');
                });
        });

        // 登出
        logoutBtn.addEventListener('click', () => {
            auth.signOut()
                .then(() => {
                    console.log('用戶已登出');
                })
                .catch((error) => {
                    console.error('登出失敗:', error);
                });
        });

        // 設置日期輸入的最小值
        function updateDateInput() {
            const today = new Date();
            const formattedDate = today.toISOString().split('T')[0];
            dueDateInput.min = formattedDate;
        }

        // 設置事件監聽器
        function setupEventListeners() {
            // 添加任務
            addTaskBtn.addEventListener('click', addTask);
            taskInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addTask();
                }
            });
            
            // 過濾按鈕
            filterBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    filterBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentFilter = this.getAttribute('data-filter');
                    renderTasks();
                });
            });
            
            // 排序選擇
            sortSelect.addEventListener('change', function() {
                currentSort = this.value;
                renderTasks();
            });
        }

        // 載入用戶任務
        async function loadUserTasks() {
            if (!currentUser) return;
            
            try {
                const snapshot = await db.collection('users')
                    .doc(currentUser.uid)
                    .collection('tasks')
                    .orderBy('createdAt', 'desc')
                    .get();
                
                tasks = [];
                snapshot.forEach((doc) => {
                    tasks.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                renderTasks();
                updateStats();
                updateTagsList();
            } catch (error) {
                console.error('載入任務失敗:', error);
            }
        }

        // 添加任務
        async function addTask() {
            const taskText = taskInput.value.trim();
            const dueDate = dueDateInput.value;
            const priority = priorityInput.value;
            const tagsText = tagsInput.value.trim();
            const tags = tagsText ? tagsText.split(',').map(tag => tag.trim()) : [];
            
            if (taskText && currentUser) {
                const newTask = {
                    text: taskText,
                    completed: false,
                    dueDate: dueDate || null,
                    priority: priority,
                    tags: tags,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    userId: currentUser.uid
                };
                
                try {
                    const docRef = await db.collection('users')
                        .doc(currentUser.uid)
                        .collection('tasks')
                        .add(newTask);
                    
                    // 添加到本地數組
                    tasks.unshift({
                        id: docRef.id,
                        ...newTask,
                        createdAt: new Date() // 本地使用當前時間
                    });
                    
                    renderTasks();
                    updateStats();
                    updateTagsList();
                    
                    // 重置表單
                    taskInput.value = '';
                    dueDateInput.value = '';
                    priorityInput.value = 'none';
                    tagsInput.value = '';
                    taskInput.focus();
                } catch (error) {
                    console.error('添加任務失敗:', error);
                    alert('添加任務失敗，請重試。');
                }
            }
        }

        // 切換任務狀態
        async function toggleTaskStatus(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task || !currentUser) return;
            
            try {
                await db.collection('users')
                    .doc(currentUser.uid)
                    .collection('tasks')
                    .doc(taskId)
                    .update({
                        completed: !task.completed
                    });
                
                // 更新本地狀態
                task.completed = !task.completed;
                renderTasks();
                updateStats();
            } catch (error) {
                console.error('更新任務狀態失敗:', error);
                alert('更新任務失敗，請重試。');
            }
        }

        // 刪除任務
        async function deleteTask(taskId) {
            if (!currentUser) return;
            
            if (confirm('確定要刪除這個任務嗎？')) {
                try {
                    await db.collection('users')
                        .doc(currentUser.uid)
                        .collection('tasks')
                        .doc(taskId)
                        .delete();
                    
                    // 從本地數組中移除
                    tasks = tasks.filter(task => task.id !== taskId);
                    renderTasks();
                    updateStats();
                    updateTagsList();
                } catch (error) {
                    console.error('刪除任務失敗:', error);
                    alert('刪除任務失敗，請重試。');
                }
            }
        }

        // 格式化日期
        function formatDate(dateString) {
            if (!dateString) return '';
            
            const date = new Date(dateString);
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return date.toLocaleDateString('zh-TW', options);
        }

        // 檢查是否為今天
        function isToday(dateString) {
            if (!dateString) return false;
            
            const date = new Date(dateString);
            const today = new Date();
            return date.getDate() === today.getDate() &&
                date.getMonth() === today.getMonth() &&
                date.getFullYear() === today.getFullYear();
        }

        // 檢查是否即將到期
        function isUpcoming(dateString) {
            if (!dateString) return false;
            
            const date = new Date(dateString);
            const today = new Date();
            const upcoming = new Date();
            upcoming.setDate(today.getDate() + 7);
            
            return date > today && date <= upcoming;
        }

        // 檢查是否已過期
        function isOverdue(dateString) {
            if (!dateString) return false;
            
            const date = new Date(dateString);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            return date < today;
        }

        // 獲取到期日狀態
        function getDueDateStatus(dateString) {
            if (!dateString) return '';
            
            if (isOverdue(dateString)) {
                return 'overdue';
            } else if (isToday(dateString)) {
                return 'due-soon';
            } else if (isUpcoming(dateString)) {
                return 'due-soon';
            }
            
            return '';
        }

        // 優先級轉換為數字
        function priorityToNumber(priority) {
            const priorities = {
                'high': 3,
                'medium': 2,
                'low': 1,
                'none': 0
            };
            return priorities[priority] || 0;
        }

        // 排序任務
        function sortTasks(tasksArray) {
            const clonedTasks = [...tasksArray];
            
            switch(currentSort) {
                case 'priority':
                    return clonedTasks.sort((a, b) => priorityToNumber(b.priority) - priorityToNumber(a.priority));
                case 'dueDate':
                    return clonedTasks.sort((a, b) => {
                        if (!a.dueDate) return 1;
                        if (!b.dueDate) return -1;
                        return new Date(a.dueDate) - new Date(b.dueDate);
                    });
                case 'createdDate':
                    return clonedTasks.sort((a, b) => {
                        const aDate = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt);
                        const bDate = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt);
                        return aDate - bDate;
                    });
                default:
                    return clonedTasks;
            }
        }

        // 過濾任務
        function filterTasks() {
            let filteredTasks = tasks;
            
            switch(currentFilter) {
                case 'active':
                    filteredTasks = tasks.filter(task => !task.completed);
                    break;
                case 'completed':
                    filteredTasks = tasks.filter(task => task.completed);
                    break;
                case 'today':
                    filteredTasks = tasks.filter(task => isToday(task.dueDate));
                    break;
                case 'upcoming':
                    filteredTasks = tasks.filter(task => isUpcoming(task.dueDate));
                    break;
                case 'overdue':
                    filteredTasks = tasks.filter(task => isOverdue(task.dueDate) && !task.completed);
                    break;
                default:
                    // 全部
                    break;
            }
            
            // 按標籤過濾
            if (currentTag) {
                filteredTasks = filteredTasks.filter(task => 
                    task.tags && task.tags.includes(currentTag)
                );
            }
            
            return sortTasks(filteredTasks);
        }

        // 渲染任務列表
        function renderTasks() {
            const filteredTasks = filterTasks();
            
            taskList.innerHTML = '';
            
            if (filteredTasks.length === 0) {
                const noTasksEl = document.createElement('p');
                noTasksEl.className = 'no-tasks';
                noTasksEl.textContent = '沒有任務';
                taskList.appendChild(noTasksEl);
                return;
            }
            
            filteredTasks.forEach(task => {
                const taskItem = document.createElement('li');
                taskItem.className = 'task-item';
                
                if (task.priority && task.priority !== 'none') {
                    taskItem.classList.add(`priority-${task.priority}`);
                }
                
                taskItem.setAttribute('data-id', task.id);
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'task-checkbox';
                checkbox.checked = task.completed;
                checkbox.addEventListener('change', () => toggleTaskStatus(task.id));
                
                const taskContent = document.createElement('div');
                taskContent.className = 'task-content';
                if (task.completed) {
                    taskContent.classList.add('completed');
                }
                
                const taskText = document.createElement('span');
                taskText.className = 'task-text';
                taskText.textContent = task.text;
                
                const taskMeta = document.createElement('div');
                taskMeta.className = 'task-meta';
                
                // 添加到期日信息
                if (task.dueDate) {
                    const dueDate = document.createElement('span');
                    dueDate.className = 'due-date';
                    
                    const status = getDueDateStatus(task.dueDate);
                    if (status) {
                        dueDate.classList.add(status);
                    }
                    
                    const icon = document.createElement('span');
                    icon.className = 'due-date-icon';
                    icon.textContent = '📅';
                    
                    const text = document.createElement('span');
                    text.textContent = formatDate(task.dueDate);
                    
                    dueDate.appendChild(icon);
                    dueDate.appendChild(text);
                    taskMeta.appendChild(dueDate);
                }
                
                // 添加優先級標籤
                if (task.priority && task.priority !== 'none') {
                    const priorityBadge = document.createElement('span');
                    priorityBadge.className = `priority-badge priority-${task.priority}`;
                    
                    let priorityText = '';
                    switch(task.priority) {
                        case 'high':
                            priorityText = '❗ 高優先級';
                            break;
                        case 'medium':
                            priorityText = '⚠️ 中優先級';
                            break;
                        case 'low':
                            priorityText = '✓ 低優先級';
                            break;
                    }
                    
                    priorityBadge.textContent = priorityText;
                    taskMeta.appendChild(priorityBadge);
                }
                
                // 添加標籤
                if (task.tags && task.tags.length > 0) {
                    const tagsContainer = document.createElement('div');
                    tagsContainer.className = 'tags-container';
                    
                    task.tags.forEach(tag => {
                        if (tag) {
                            const tagBadge = document.createElement('span');
                            tagBadge.className = 'tag';
                            tagBadge.textContent = tag;
                            tagsContainer.appendChild(tagBadge);
                        }
                    });
                    
                    taskMeta.appendChild(tagsContainer);
                }
                
                taskContent.appendChild(taskText);
                taskContent.appendChild(taskMeta);
                
                const taskActions = document.createElement('div');
                taskActions.className = 'task-actions';
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'action-btn delete-btn';
                deleteBtn.textContent = '刪除';
                deleteBtn.addEventListener('click', () => deleteTask(task.id));
                
                taskActions.appendChild(deleteBtn);
                
                taskItem.appendChild(checkbox);
                taskItem.appendChild(taskContent);
                taskItem.appendChild(taskActions);
                taskList.appendChild(taskItem);
            });
        }

        // 更新統計信息
        function updateStats() {
            const totalTasks = tasks.length;
            const completedTasks = tasks.filter(task => task.completed).length;
            const activeTasks = totalTasks - completedTasks;
            const dueTodayTasks = tasks.filter(task => isToday(task.dueDate) && !task.completed).length;
            const overdueTasks = tasks.filter(task => isOverdue(task.dueDate) && !task.completed).length;
            
            taskStats.textContent = `總共: ${totalTasks} | 已完成: ${completedTasks} | 進行中: ${activeTasks} | 今天到期: ${dueTodayTasks} | 已過期: ${overdueTasks}`;
        }

        // 更新標籤列表
        function updateTagsList() {
            // 獲取所有任務的所有唯一標籤
            const allTags = new Set();
            tasks.forEach(task => {
                if (task.tags && task.tags.length > 0) {
                    task.tags.forEach(tag => {
                        if (tag) {
                            allTags.add(tag);
                        }
                    });
                }
            });
            
            // 清空標籤列表
            tagList.innerHTML = '';
            
            // 如果有標籤，則創建"全部"標籤按鈕
            if (allTags.size > 0) {
                const allTagBtn = document.createElement('button');
                allTagBtn.className = 'tag-btn' + (currentTag === null ? ' active' : '');
                allTagBtn.textContent = '全部標籤';
                allTagBtn.addEventListener('click', () => {
                    // 移除所有標籤按鈕的active類
                    document.querySelectorAll('.tag-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    
                    allTagBtn.classList.add('active');
                    currentTag = null;
                    renderTasks();
                });
                tagList.appendChild(allTagBtn);
                
                // 創建每個標籤的按鈕
                Array.from(allTags).sort().forEach(tag => {
                    const tagBtn = document.createElement('button');
                    tagBtn.className = 'tag-btn' + (currentTag === tag ? ' active' : '');
                    tagBtn.textContent = tag;
                    tagBtn.addEventListener('click', () => {
                        // 移除所有標籤按鈕的active類
                        document.querySelectorAll('.tag-btn').forEach(btn => {
                            btn.classList.remove('active');
                        });
                        
                        tagBtn.classList.add('active');
                        currentTag = tag;
                        renderTasks();
                    });
                    tagList.appendChild(tagBtn);
                });
            }
        }
    </script>
</body>
</html>